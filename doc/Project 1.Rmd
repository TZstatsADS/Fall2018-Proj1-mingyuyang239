---
title: "Project 1"
author: "Mingyu Yang"
date: "9/12/2018"
output:
  pdf_document: default
  html_document: default
---

#An Analysis on Finding Happiness As Single Parents? How Do Experiences that Make Them Happy Compare to These for Married Parents and Non-parents?


According to data published by the United States' Census Bureau, around 30% of children in the United States are raised by single parents. There are many debates on whether single parents are as "good" as married ones. Those debates surround on topics including financial stability, psychological effect on children, social mobility and etc. These topics typically focus on the state of children instead of the parent herself/himself. An interesting question come in mind is what are the things that make single parents happy? Are they any different than those for married ones? How about comparing them to non-parents?

For our study, we will use the dataset HappyDB. It is a corpus of 100,000 happy moments gathered by the Amazon Mechanical Turk in 2017. We will compare data provided by single parent and married parent respectively. We will then study data provided by single and married non-parents and see if there exists similar trend as people with children. 

The current R version I'm using and the necessary packages used are listed below. The original data are imported and we did some cleaning of the data. We removed punctuations, extra whitespace, empty words and numbers and converted upper case to lower case. We reduced words to their stems and removed meaningless stop words. We further combined the demographic data with the original data set. We then imported the demographic data to our cleaned data. We will use this cleaned and combined data for our analysis below.


```{r load libraries,warning=FALSE, message=FALSE}
library(tidyverse)
library(tidytext)
library(DT)
library(scales)
library(wordcloud2)
library(gridExtra)
library(ngram)
library(tm)
library(wordcloud)
library(syuzhet)
library(topicmodels)
library(ggplot2)
library(dplyr)
library(beeswarm)
library(gplots)
library(reshape2)

R.Version()$version.string
```

```{r load data, warning=FALSE, message=FALSE, echo=FALSE}
#combine data with demo data
hm_data <- read_csv("../output/processed_moments.csv")
urlfile<-'https://raw.githubusercontent.com/rit-public/HappyDB/master/happydb/data/demographic.csv'
demo_data <- read_csv(urlfile)
```

```{r combining data, warning=FALSE, message=FALSE,echo=FALSE}
hm_data <- hm_data %>%
  inner_join(demo_data, by = "wid") %>%
  select(wid,
         original_hm,
         gender, 
         marital, 
         parenthood,
         reflection_period,
         age, 
         country, 
         ground_truth_category, 
         text) %>%
  mutate(count = sapply(hm_data$text, wordcount)) %>%
  filter(gender %in% c("m", "f")) %>%
  filter(marital %in% c("single", "married")) %>%
  filter(parenthood %in% c("n", "y")) %>%
  filter(reflection_period %in% c("24h", "3m")) %>%
  mutate(reflection_period = fct_recode(reflection_period, 
                                        months_3 = "3m", hours_24 = "24h"))
```

```{r, echo=FALSE}
#substract data sets 
hm_data.sp <- hm_data[hm_data$marital == "single" & hm_data$parenthood == "y",]
hm_data.mp <- hm_data[hm_data$marital == "married" & hm_data$parenthood == "y",]
hm_data.cp <- rbind(hm_data.sp,hm_data.mp)

hm_data.s <- hm_data[hm_data$marital == "single" & hm_data$parenthood == "n",]
hm_data.m <- hm_data[hm_data$marital == "married" & hm_data$parenthood == "n",]
hm_data.c <- rbind(hm_data.s,hm_data.m)

hm_data.cp$status <- ifelse(hm_data.cp$marital == "single", "Single Parents", "Married Parents")
hm_data.c$status <-ifelse(hm_data.c$marital == "single", "Single Non-parents", "Married Non-parents")
alldata <- rbind(hm_data.cp,hm_data.c)
```

#General Analysis
##Length of Sentences

The length of sentences are stored in the count column of our cleaned dataset and we visualized this through a scatterplot, where each color represent a group within the plot. 

```{r}
ggplot(alldata, aes(count, status, color = status)) +
  geom_point() + 
  geom_jitter(width = 0.5, height = 0.3) + 
  ggtitle("Length of Sentences for Four Groups") +
  labs(x = "Length of Sentences", y = "Demographic Groups")

```
From the plot, we observe that married parents wrote more words in descripting their experiences. These may be because we have more data on married parents comparing to the other three groups. 

## Word Frequency with Wordcloud.

We are going to examine the frequencies of words for each group and generate a word cloud for each demographic group.   



```{r}
#wordcloud for single parents. 
docs.sp <- Corpus(VectorSource(hm_data.sp$text))
dtm.sp <- TermDocumentMatrix(docs.sp)
m.sp <- as.matrix(dtm.sp)
v.sp <- sort(rowSums(m.sp),decreasing=TRUE)
d.sp <- data.frame(word = names(v.sp),freq=v.sp)

set.seed(123)
wordcloud(words = d.sp$word, freq = d.sp$freq, min.freq = 1,
          max.words=100, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))
```

```{r}
#wordcloud for married parents
docs.mp <- Corpus(VectorSource(hm_data.mp$text))
dtm.mp <- TermDocumentMatrix(docs.mp)
m.mp <- as.matrix(dtm.mp)
v.mp <- sort(rowSums(m.mp),decreasing=TRUE)
d.mp <- data.frame(word = names(v.mp),freq=v.mp)

set.seed(123)
wordcloud(words = d.mp$word, freq = d.mp$freq, min.freq = 1,
          max.words=100, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))
```
The top three most frequent appearance words are "day", "time" and "friends" for single-parents and are "day", "time" and "son" for married parents. The word "friend" drops to the fifth place for married parents. This indicates friends may be a more important aspect of life for single parent. 

```{r}
#wordcould for single non-parents.
docs.s <- Corpus(VectorSource(hm_data.s$text))
dtm.s <- TermDocumentMatrix(docs.s)
m.s <- as.matrix(dtm.s)
v.s <- sort(rowSums(m.s),decreasing=TRUE)
d.s <- data.frame(word = names(v.s),freq=v.s)
head(d.s, 10)

set.seed(123)
wordcloud(words = d.s$word, freq = d.s$freq, min.freq = 1,
          max.words=100, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))
```

```{r}
#wordcould for married non-parents.
docs.m <- Corpus(VectorSource(hm_data.m$text))
dtm.m <- TermDocumentMatrix(docs.m)
m.m <- as.matrix(dtm.m)
v.m <- sort(rowSums(m.m),decreasing=TRUE)
d.m <- data.frame(word = names(v.m),freq=v.m)
head(d.m, 10)

set.seed(123)
wordcloud(words = d.m$word, freq = d.m$freq, min.freq = 1,
          max.words=100, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))

```
Let's take a look at the comparison between single non-parents and married non-parents. The top three most frequent words are the same for both groups. They are "date", "time" and "friends". Besides the obvious finding that non-parents would not have the term "son" or "daughter" on their lists, the words "family", "husband", and "wife" did not make it to the top three. For people who don't have children, even if they are married, they seems to put more emphasize on friends instead of families.

#Sentiment Analysis 

We will measure the sentiments of these happy moments. Although they should all exhibit positive and joyful sentiment indicating by the study, the intensities of the sentiments may vary between groups. 


```{r}
# all samples vs. single parents vs. married parents
par(mfrow = c(1,3))
sentiment.all <- get_sentiment(hm_data$text, method = "syuzhet")
boxplot(sentiment.all, ylim=c(-5,20), main = "All Samples", ylab = "All Samples")

sentiment.sp <- get_sentiment(hm_data.sp$text, method = "syuzhet")
boxplot(sentiment.sp, ylim=c(-5,20), main = "Sentimental Analysis-Single Parent", ylab = "Single Parent")

sentiment.mp <- get_sentiment(hm_data.mp$text, method = "syuzhet")
boxplot(sentiment.mp, ylim=c(-5,20), main = "Sentimental Analysis-Married Parent", ylab = "Married Parent")
```
We first compare single parents to married ones. There isn't a significant difference by looking at the boxplot. Looking at the mean of the sentiment score, both groups of parents have higher sentiment score comparing to the entire samples set. Married couple has a slightly higher score than the single ones. We neglect other factors such as socioeconomic status which may also play a role in this analysis. 


```{r}
par(mfrow = c(1,3))

boxplot(sentiment.all, ylim=c(-5,20), main = "All Samples", ylab = "All Samples")

sentiment.s <- get_sentiment(hm_data.s$text, method = "syuzhet")
boxplot(sentiment.s, ylim=c(-5,20), main = "Sentimental Analysis-Single Non-parents", ylab = "Single Non-parent")

sentiment.m <- get_sentiment(hm_data.m$text, method = "syuzhet")
boxplot(sentiment.m, ylim=c(-5,20), main = "Sentimental Analysis-Non-parents", ylab = "Non-parents")
```
We then take a look at the sentiment scores of non-parents individuals. An interesting finding is that non-parents individuals has lower scores the entire sample set. Married individuals still has high score than single ones but the difference is really small.

```{r, echo=false}
mean(sentiment.all)
mean(sentiment.sp)
mean(sentiment.mp)
mean(sentiment.all)
mean(sentiment.s)
mean(sentiment.m)
```

```{r}
#find the happiest sentences for parents
hm_data[which.max(sentiment.sp),]$original_hm
hm_data[which.max(sentiment.mp),]$original_hm

#find the happiest sentences for non-parents
hm_data[which.max(sentiment.s),]$original_hm
hm_data[which.max(sentiment.m),]$original_hm

```
Let's look at the happiest moment for each group. Not surprising, the happiest moments for parents, married or not, include mentioning family members. The happiest moments for non-parents both describe specific experiences.

# Topic Modeling 

We will extract topics with fitting a LDA model. We will try setting the numbers of topics as three to six. It turns out that setting three topics number make the most sense. The beta matrix tells us the probabilities of each word being generated from each topic. We see that the word accepted is generated from the topic 1 with a probability of 7.521082e-05. 


```{r}
order.data.cp <- hm_data.cp[order(hm_data.cp$wid),]
order.data.cp$status <- ifelse(order.data.cp$marital == "single", 1, 2)
order.data.c <- hm_data.c[order(hm_data.c$wid),]
order.data.c$status <- ifelse(order.data.c$marital == "single", 3, 4)

combine <- rbind(order.data.cp,order.data.c)

combine.data <- combine  %>% 
                group_by(wid) %>% 
                summarise(text = paste(text, collapse = " "), status = mean(status))

combine.docs <- Corpus(VectorSource(combine.data$text))
dtm.combine <- DocumentTermMatrix(combine.docs)

lda <- LDA(dtm.combine, k = 3, control = list(seed = 2))
```

```{r}
# the beta matrix 
topics <- tidy(lda, matrix = "beta")
head(topics,6)
```
We visualized the top five most frequent words in each topics. According to those words, we manually tag each topic as "Family", "Job" and "Friend".
```{r}
#Find the top ten words in each topic. 
top.words <- topics %>%
  group_by(topic) %>%
  top_n(10, beta) %>%
  ungroup() %>%
  arrange(topic, -beta)

top.words %>%
  mutate(term = reorder(term, beta)) %>%
  ggplot(aes(term, beta, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  coord_flip()
```

We use a heatmap to visualized which topic is mensioned more frequently for each demographic group. From the heat map, we observe that "friend" is a topic that are mentioned the most for all four groups. Married parents seems to find more happiness in families than the other three groups.
```{r}
topic.prob <- as.data.frame(lda@gamma)
topics.tag <- c("Family", "Job", "Friend")
lda.topics <- as.matrix(topics(lda))
combine.data$topic <- as.vector(lda.topics)
combine.data$ldatag <- topics.tag[lda.topics]
colnames(topic.prob) <- topics.tag

combine.data.corpus <- cbind(combine.data,topic.prob)
```


```{r}
topic.status<-tbl_df(combine.data.corpus)%>%
              select(status, Family:Friend)%>%
              group_by(status)%>%
              summarise_all(funs(mean))
topic.status=as.data.frame(topic.status)

rownames(topic.status)<-topic.status$status


as.mat <- as.matrix(topic.status[,-1])
rownames(as.mat) <- c('Single Parents','Married Parents','Single Non-parents','Married Non-parents')
melted_topic <- melt(as.mat)
ggplot(data = melted_topic, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()
```

#Conclusion

Married parent seems to use longer sentences in describing their happy moments. There is not a significant difference in sentences length between the other three groups.

Friend is an important aspect for single parents than married parents. Family related words appear less frequent for people who are married but don't have children.   

Moments describing by parents are more joyful than non-parents. Moments written by people who are married are more joyful than people who are single.   

For the three topics "friend", "job" and "Friend", "Friend" is a topic that are mentioned the most for all four groups. Married parents seems to find more happiness in families than the other three groups.   


#Sources:

http://www.sthda.com/english/wiki/text-mining-and-word-cloud-fundamentals-in-r-5-simple-steps-you-should-know

https://www.tidytextmining.com/topicmodeling.html

https://medium.freecodecamp.org/a-data-scientists-guide-to-happiness-findings-from-the-happy-experiences-of-10-000-humans-fc02b5c8cbc1
